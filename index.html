<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>360 VR Mobile Player</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; z-index: 10; }
        canvas { display: block; width: 100vw; height: 100vh; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 8px; }
        input[type="file"] { margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>360Â° Gyro Player</h1>
        <input type="file" id="videoUpload" accept="video/*"><br>
        <button id="startBtn">Enter VR Mode</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let scene, camera, renderer, video, texture;

        const ui = document.getElementById('ui');
        const startBtn = document.getElementById('startBtn');
        const fileInput = document.getElementById('videoUpload');

        function init() {
            // 1. Setup Scene & Camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0); // Put camera at center

            // 2. Setup Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // 3. Create the Sphere
            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1); // Invert the sphere so the video is visible from INSIDE

            video = document.createElement('video');
            video.loop = true;
            video.muted = false; // You can unmute after user interaction
            video.playsInline = true;

            texture = new THREE.VideoTexture(video);
            const material = new THREE.MeshBasicMaterial({ map: texture });
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Handle Video File
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            video.src = URL.createObjectURL(file);
        };

        // Start Gyro and Fullscreen
        startBtn.addEventListener('click', async () => {
            if (!video.src) { alert("Please select a video first!"); return; }

            // Request permission for iOS 13+
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') window.addEventListener('deviceorientation', setOrientation);
            } else {
                window.addEventListener('deviceorientation', setOrientation);
            }

            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            
            ui.style.display = 'none';
            video.play();
        });

        function setOrientation(event) {
            // Convert Euler angles (alpha, beta, gamma) to Radians
            const alpha = event.alpha ? THREE.MathUtils.degToRad(event.alpha) : 0; // Z
            const beta = event.beta ? THREE.MathUtils.degToRad(event.beta) : 0;   // X
            const gamma = event.gamma ? THREE.MathUtils.degToRad(event.gamma) : 0; // Y

            // Create an Euler rotation order for smooth looking around
            // We use 'ZXY' for mobile orientation compatibility
            camera.rotation.set(beta, alpha, -gamma, 'ZXY');
        }

        init();
    </script>
</body>
</html>
